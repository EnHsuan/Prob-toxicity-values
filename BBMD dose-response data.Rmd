---
title: "dose-response data"
author: "En-Hsuan Lu"
date: "2023-08-30"
output: html_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(ggpubr)
knitr::opts_chunk$set(echo = TRUE)
```

## read chemicals
23 endpoints

```{r read}
dr_conc <- read.csv("dose-response_cont.csv")
dr_dich <- read.csv("dose-response_dich.csv")

dr_dich$mean <- dr_dich$incidence/dr_dich$N
dr_dich$SD <- (dr_dich$mean*(1-dr_dich$mean)/dr_dich$N)^(1/2)
```

#aldrin

```{r ggplot}
#aldrin
aldrin.orig <- ggplot(subset(dr_dich, chemical %in% "aldrin"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 0.025, linetype="dashed", color="red")+
  annotate("label", x=0.025, y=Inf, vjust = 2, label="LOAEL", color="red")+
  ggtitle("Aldrin", subtitle="Nonneoplastic liver lesions")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(aldrin.orig)

#modeling
pm <- read.csv(file.path("BBMD input","aldrin-nonneoplastic-liver-lesion-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "aldrin")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (25.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (2.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (14.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (2.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (31.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (14.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (8.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (0.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","aldrin-nonneoplastic-liver-lesion-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.025, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

aldrin.dr <- ggarrange(aldrin.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(aldrin.dr)
ggsave("aldrin liver lesion.pdf",plot=aldrin.dr, width=24, height=6, path="dose-response plots")
ggsave("aldrin liver lesion seminar.pdf",plot=aldrin.dr, width=24, height=6, path="dose-response plots", scale=0.7)
```

#azinphos-methyl
male

```{r ggplot}
#azinphos-methyl
#male
azin.m.orig <- ggplot(subset(dr_conc, chemical %in% "azinphos-methyl" & sex=="male"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (μmol/ml/min)")+
  geom_vline(xintercept = 0.3, linetype="dashed", color="red")+
  annotate("label", x=0.3, y=Inf, vjust=2, label="BMDL", color="red")+
  ggtitle("Azinphos-methyl", subtitle="Inhibition of erythrocyte AChE activity in males")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(azin.m.orig)

#modeling
pm <- read.csv(file.path("BBMD input","azinphos-methyl-male-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "azinphos-methyl" & sex=="male")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (34.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (5.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (12.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (7.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (4.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (3.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (14.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (19.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","azinphos-methyl-male-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.3, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

azin.m.dr <- ggarrange(azin.m.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(azin.m.dr)
ggsave("azinphos-methyl male.pdf",plot=azin.m.dr, width=24, height=6, path="dose-response plots")
```

#chlorpyrifos
male rbc
the most sensitive POD

```{r ggplot}
#chlorpyrifos
#male rbc
chlo.rbc.m.orig <- ggplot(subset(dr_conc, chemical %in% "chlopyrifos" & endpoint=="rbc" & sex=="male"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.1)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (μmole/ml/min)")+
  geom_vline(xintercept = 0.1, linetype="dashed", color="red")+
  annotate("label", x=0.1, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Chlorpyrifos", subtitle="RBC cholinesterase inhibition in males")+theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(chlo.rbc.m.orig)

#modeling
pm <- read.csv(file.path("BBMD input","chlopyrifos-rbc-male-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "chlopyrifos" & endpoint=="rbc" & sex=="male")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (50.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (14.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (25.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (9.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","chlopyrifos-rbc-male-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.1, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

chlo.rbc.m.dr <- ggarrange(chlo.rbc.m.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(chlo.rbc.m.dr)
ggsave("chlorpyrifos rbc male.pdf",plot=chlo.rbc.m.dr, width=24, height=6, path="dose-response plots")
```

#chlorpyrifos
female rbc

```{r ggplot}
#chlorpyrifos
#female rbc
chlo.rbc.f.orig <- ggplot(subset(dr_conc, chemical %in% "chlopyrifos" & endpoint=="rbc" & sex=="female"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.1)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (μmole/ml/min)")+
  geom_vline(xintercept = 0.1, linetype="dashed", color="red")+
    annotate("label", x=0.1, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Chlorpyrifos", subtitle="RBC cholinesterase inhibition in females")+theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(chlo.rbc.f.orig)

#modeling
pm <- read.csv(file.path("BBMD input","chlopyrifos-rbc-female-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "chlopyrifos" & endpoint=="rbc" & sex=="female")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (17.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (39.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (41.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (1.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","chlopyrifos-rbc-female-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.1, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

chlo.rbc.f.dr <- ggarrange(chlo.rbc.f.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(chlo.rbc.f.dr)
ggsave("chlorpyrifos rbc female.pdf",plot=chlo.rbc.f.dr, width=24, height=6, path="dose-response plots")
```

#chlorpyrifos
male plasma

```{r ggplot}
#chlorpyrifos
#male plasma
chlo.pl.m.orig <- ggplot(subset(dr_conc, chemical %in% "chlopyrifos" & endpoint=="plasma" & sex=="male"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.1)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (μmole/ml/min)")+
  geom_vline(xintercept = 0.1, linetype="dashed", color="red")+
  annotate("label", x=0.1, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Chlorpyrifos", subtitle="Plasma cholinesterase inhibition in males")+theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(chlo.pl.m.orig)

#modeling
pm <- read.csv(file.path("BBMD input","chlopyrifos-plasma-male-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "chlopyrifos" & endpoint=="plasma" & sex=="male")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (25.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (2.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (20.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (11.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (6.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (1.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (12.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (19.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","chlopyrifos-plasma-male-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.1, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

chlo.pl.m.dr <- ggarrange(chlo.pl.m.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(chlo.pl.m.dr)
ggsave("chlorpyrifos plasma male.pdf",plot=chlo.pl.m.dr, width=24, height=6, path="dose-response plots")
```

#chlorpyrifos
female plasma

```{r ggplot}
#chlorpyrifos
#female plasma
chlo.pl.f.orig <- ggplot(subset(dr_conc, chemical %in% "chlopyrifos" & endpoint=="plasma" & sex=="female"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.1)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (μmole/ml/min)")+
  geom_vline(xintercept = 0.1, linetype="dashed", color="red")+
  annotate("label", x=0.1, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Chlorpyrifos", subtitle="Plasma cholinesterase inhibition in females")+theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(chlo.pl.f.orig)

#modeling
pm <- read.csv(file.path("BBMD input","chlopyrifos-plasma-female-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "chlopyrifos" & endpoint=="plasma" & sex=="female")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (30.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (4.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (31.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (7.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (2.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (1.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (12.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (10.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","chlopyrifos-plasma-female-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.1, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

chlo.pl.f.dr <- ggarrange(chlo.pl.f.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(chlo.pl.f.dr)
ggsave("chlorpyrifos plasma female.pdf",plot=chlo.pl.f.dr, width=24, height=6, path="dose-response plots")
```

#chlorpyrifos
male brain

```{r ggplot}
#chlorpyrifos
#male brain
chlo.br.m.orig <- ggplot(subset(dr_conc, chemical %in% "chlopyrifos" & endpoint=="brain" & sex=="male"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.1)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (μmole/ml/min)")+
  geom_vline(xintercept = 0.1, linetype="dashed", color="red")+
  annotate("label", x=0.1, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Chlorpyrifos", subtitle="Brain cholinesterase inhibition in males")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(chlo.br.m.orig)

#modeling
pm <- read.csv(file.path("BBMD input","chlopyrifos-brain-male-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "chlopyrifos" & endpoint=="brain" & sex=="male")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (30.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (6.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (19.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (6.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (6.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (2.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (15.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (13.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","chlopyrifos-brain-male-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.1, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

chlo.br.m.dr <- ggarrange(chlo.br.m.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(chlo.br.m.dr)
ggsave("chlorpyrifos brain male.pdf",plot=chlo.br.m.dr, width=24, height=6, path="dose-response plots")
```

#chlorpyrifos
female brain

```{r ggplot}
#chlorpyrifos
#female brain
chlo.br.f.orig <- ggplot(subset(dr_conc, chemical %in% "chlopyrifos" & endpoint=="brain" & sex=="female"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.1)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (μmole/ml/min)")+
  geom_vline(xintercept = 0.1, linetype="dashed", color="red")+
  annotate("label", x=0.1, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Chlorpyrifos", subtitle="Brain cholinesterase inhibition in females")+theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(chlo.br.f.orig)

#modeling
pm <- read.csv(file.path("BBMD input","chlopyrifos-brain-female-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "chlopyrifos" & endpoint=="brain" & sex=="female")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (1.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (28.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (0.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (16.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (15.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (28.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (0.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (9.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","chlopyrifos-brain-female-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.1, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

chlo.br.f.dr <- ggarrange(chlo.br.f.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(chlo.br.f.dr)
ggsave("chlorpyrifos brain female.pdf",plot=chlo.br.f.dr, width=24, height=6, path="dose-response plots")
```

#dicofol
female brain
the most sensitive POD

```{r ggplot}
#dicofol
#female brain
dico.f.orig <- ggplot(subset(dr_conc, chemical %in% "dicofol" & sex=="female"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.1)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (μg/100 ml)")+
  geom_vline(xintercept = 0.12, linetype="dashed", color="red")+
  annotate("label", x=0.12, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Dicofol", subtitle="Inhibition in ACTH stimulated cortisol release \nin females")+theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(dico.f.orig)

#modeling
pm <- read.csv(file.path("BBMD input","dicofol-female-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "dicofol" & sex=="female")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (27.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (6.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (14.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (4.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (4.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (6.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (13.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (23.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","dicofol-female-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.12, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

dico.f.dr <- ggarrange(dico.f.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(dico.f.dr)
ggsave("dicofol female.pdf",plot=dico.f.dr, width=24, height=6, path="dose-response plots")
```

#dicofol
male brain

```{r ggplot}
#dicofol
#male brain
dico.m.orig <- ggplot(subset(dr_conc, chemical %in% "dicofol" & sex=="male"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.1)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (μg/100 ml)")+
  geom_vline(xintercept = 0.12, linetype="dashed", color="red")+
  annotate("label", x=0.12, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Dicofol", subtitle="Inhibition in ACTH stimulated cortisol release \nin males")+theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(dico.m.orig)

#modeling
pm <- read.csv(file.path("BBMD input","dicofol-male-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "dicofol" & sex=="male")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (26.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (7.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (12.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (6.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (4.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (6.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (13.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (23.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","dicofol-male-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.12, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

dico.m.dr <- ggarrange(dico.m.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(dico.m.dr)
ggsave("dicofol male.pdf",plot=dico.m.dr, width=24, height=6, path="dose-response plots")
```

#dieldrin
liver weight
the most sensitive POD

```{r ggplot}
#dieldrin
#liver weight
diel.liw.orig <- ggplot(subset(dr_conc, chemical %in% "dieldrin" & endpoint=="liver weight"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.01)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (g)")+
  geom_vline(xintercept = 0.005, linetype="dashed", color="red")+
    annotate("label", x=0.005, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Dieldrin", subtitle="Increased liver weights")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(diel.liw.orig)

#modeling
pm <- read.csv(file.path("BBMD input","dieldrin-liver-weight-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "dieldrin" & endpoint=="liver weight")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (37.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (20.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (17.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (24.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","dieldrin-liver-weight-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.005, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

diel.liw.dr <- ggarrange(diel.liw.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(diel.liw.dr)
ggsave("dieldrin liver weight.pdf",plot=diel.liw.dr, width=24, height=6, path="dose-response plots")
```

#dieldrin
liver bw ratio

```{r ggplot}
#dieldrin
#liver ratio
diel.lir.orig <- ggplot(subset(dr_conc, chemical %in% "dieldrin" & endpoint=="liver ratio"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.01)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (g/100 g body weight)")+
  geom_vline(xintercept = 0.005, linetype="dashed", color="red")+
  annotate("label", x=0.005, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Dieldrin", subtitle="Increased liver-to-body weight ratio")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(diel.lir.orig)

#modeling
pm <- read.csv(file.path("BBMD input","dieldrin-liver-bw-ratio-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "dieldrin" & endpoint=="liver ratio")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (14.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (6.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (17.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (61.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","dieldrin-liver-bw-ratio-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.005, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

diel.lir.dr <- ggarrange(diel.lir.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(diel.lir.dr)
ggsave("dieldrin liver bw ratio.pdf",plot=diel.lir.dr, width=24, height=6, path="dose-response plots")
```

#endosulfan
male bw
the most sensitive POD

```{r ggplot}
#endosulfan
#male bw
endo.bw.m.orig <- ggplot(subset(dr_conc, chemical %in% "endosulfan" & endpoint=="bw" & sex=="male"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.1)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (g)")+
  geom_vline(xintercept = 0.6, linetype="dashed", color="red")+
  annotate("label", x=0.6, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Endosulfan", subtitle="Reduced body weight gain in males")+theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(endo.bw.m.orig)

#modeling
pm <- read.csv(file.path("BBMD input","endosulfan-bw-male-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "endosulfan" & endpoint=="bw" & sex=="male")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (14.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (1.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (43.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (6.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (5.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (1.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (14.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (12.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","endosulfan-bw-male-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.6, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

endo.bw.m.dr <- ggarrange(endo.bw.m.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(endo.bw.m.dr)
ggsave("endosulfan bw male.pdf",plot=endo.bw.m.dr, width=24, height=6, path="dose-response plots")
```

#endosulfan
female bw

```{r ggplot}
#endosulfan
#female bw
endo.bw.f.orig <- ggplot(subset(dr_conc, chemical %in% "endosulfan" & endpoint=="bw" & sex=="female"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.1)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (g)")+
  geom_vline(xintercept = 0.7, linetype="dashed", color="red")+
  annotate("label", x=0.7, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Endosulfan", subtitle="Reduced body weight gain in females")+theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(endo.bw.f.orig)

#modeling
pm <- read.csv(file.path("BBMD input","endosulfan-bw-female-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "endosulfan" & endpoint=="bw" & sex=="female")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (21.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (12.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (8.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (9.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (5.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (12.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (8.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (22.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","endosulfan-bw-female-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.7, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

endo.bw.f.dr <- ggarrange(endo.bw.f.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(endo.bw.f.dr)
ggsave("endosulfan bw female.pdf",plot=endo.bw.f.dr, width=24, height=6, path="dose-response plots")
```

#endosulfan
Glomerulonephrosis male

```{r ggplot}
##endosulfan
#Glomerulonephrosis male
endo.glo.m.orig <- ggplot(subset(dr_dich, chemical %in% "endosulfan" & endpoint=="glomeru" & sex=="male"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 0.6, linetype="dashed", color="red")+
  annotate("label", x=0.6, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Endosulfan", subtitle="Increased incidence of marked progressive \nglomerulonephrosis in males")+theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(endo.glo.m.orig)

#modeling
pm <- read.csv(file.path("BBMD input","endosulfan-glomerulo-male-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "endosulfan" & endpoint=="glomeru" & sex=="male")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (22.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (6.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (22.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (5.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (23.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (9.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (7.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (3.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","endosulfan-glomerulo-male-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 2.7, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

endo.glo.m.dr <- ggarrange(endo.glo.m.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(endo.glo.m.dr)
ggsave("endosulfan glomerulonephrosis male.pdf",plot=endo.glo.m.dr, width=24, height=6, path="dose-response plots")
```

#heptachlor

```{r ggplot}
#heptachlor
hept.orig <- ggplot(subset(dr_conc, chemical %in% "heptachlor"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.1)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab(expression(Response~(log[2](serum~titer))))+
  geom_vline(xintercept = 0.03, linetype="dashed", color="red")+
  annotate("label", x=0.03, y=Inf, vjust=2, label="LOAEL", color="red")+
  ggtitle("Heptachlor", subtitle="Reduction in IgG antibody response to SRBCs")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(hept.orig)

#modeling
pm <- read.csv(file.path("BBMD input","heptachlor-igm-response-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "heptachlor")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (18.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (9.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (27.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (10.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (6.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (8.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (18.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","heptachlor-igm-response-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.03, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

hept.dr <- ggarrange(hept.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(hept.dr)
ggsave("heptachlor IgG.pdf",plot=hept.dr, width=24, height=6, path="dose-response plots")
```

#methoxychlor

```{r ggplot}
##methoxychlor
mtc.orig <- ggplot(subset(dr_dich, chemical %in% "methoxychlor"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 5.01, linetype="dashed", color="red")+
  annotate("label", x=5.01, y=Inf, vjust=2, label="NOEL", color="red")+
  ggtitle("Methoxychlor", subtitle="Excessive loss of litters")+theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(mtc.orig)

#modeling
pm <- read.csv(file.path("BBMD input","methoxychlor-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "methoxychlor")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (6.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (13.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (7.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (6.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (35.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (11.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (5.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (13.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","methoxychlor-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 5.01, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

mtc.dr <- ggarrange(mtc.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(mtc.dr)
ggsave("methoxychlor.pdf",plot=mtc.dr, width=24, height=6, path="dose-response plots")
```


#pentachlorophenol
liver pigment female
the most sensitive POD

```{r ggplot}
#pentachlorophenol
#liver pigment female
pcp.li.f.orig <- ggplot(subset(dr_dich, chemical %in% "pentachlorophenol" & endpoint=="liver" & sex=="female"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 1.5, linetype="dashed", color="red")+
  annotate("label", x=1.5, y=Inf, vjust=5, label="LOAEL", color="red")+
  ggtitle("Pentachlorophenol", subtitle="Hepatocellular pigmentation in females")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(pcp.li.f.orig)

#modeling
pm <- read.csv(file.path("BBMD input","pentachlorophenol-liver-pigment-female-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "pentachlorophenol" & endpoint=="liver" & sex=="female")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (27.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (10.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (6.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (10.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (22.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (11.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (8.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (2.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","pentachlorophenol-liver-pigment-female-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 1.5, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

pcp.li.f.dr <- ggarrange(pcp.li.f.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(pcp.li.f.dr)
ggsave("pentachlorophenol liver pigment female.pdf",plot=pcp.li.f.dr, width=24, height=6, path="dose-response plots")
```

#pentachlorophenol
liver pigment male

```{r ggplot}
#pentachlorophenol
#liver pigment male
pcp.li.m.orig <- ggplot(subset(dr_dich, chemical %in% "pentachlorophenol" & endpoint=="liver" & sex=="male"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 1.5, linetype="dashed", color="red")+
  annotate("label", x=1.5, y=Inf, vjust=5, label="LOAEL", color="red")+
  ggtitle("Pentachlorophenol", subtitle="Hepatocellular pigmentation in males")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(pcp.li.m.orig)

#modeling
pm <- read.csv(file.path("BBMD input","pentachlorophenol-liver-pigment-male-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "pentachlorophenol" & endpoint=="liver" & sex=="male")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (27.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (10.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (6.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (10.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (22.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (11.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (8.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (2.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","pentachlorophenol-liver-pigment-male-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 1.5, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

pcp.li.m.dr <- ggarrange(pcp.li.m.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(pcp.li.m.dr)
ggsave("pentachlorophenol liver pigment male.pdf",plot=pcp.li.m.dr, width=24, height=6, path="dose-response plots")
```

#pentachlorophenol
Cytoplasmic vacuolization male

```{r ggplot}
#pentachlorophenol
#Cytoplasmic vacuolization male
pcp.cy.m.orig <- ggplot(subset(dr_dich, chemical %in% "pentachlorophenol" & endpoint=="cyto" & sex=="male"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 1.5, linetype="dashed", color="red")+
  annotate("label", x=1.5, y=Inf, vjust=2, label="LOAEL", color="red")+
  ggtitle("Pentachlorophenol", subtitle="Cytoplasmic vacuolation in males")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(pcp.cy.m.orig)

#modeling
pm <- read.csv(file.path("BBMD input","pentachlorophenol-cyto-vacuolization-male-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "pentachlorophenol" & endpoint=="cyto" & sex=="male")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (13.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (21.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (15.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (18.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (6.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (5.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (12.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (5.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","pentachlorophenol-cyto-vacuolization-male-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 1.5, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

pcp.cy.m.dr <- ggarrange(pcp.cy.m.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(pcp.cy.m.dr)
ggsave("pentachlorophenol cytoplasmic vacuolization male.pdf",plot=pcp.cy.m.dr, width=24, height=6, path="dose-response plots")
```

#pentachlorophenol
Cytoplasmic vacuolization female

```{r ggplot}
#pentachlorophenol
#Cytoplasmic vacuolization female
pcp.cy.f.orig <- ggplot(subset(dr_dich, chemical %in% "pentachlorophenol" & endpoint=="cyto" & sex=="female"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 1.5, linetype="dashed", color="red")+
  annotate("label", x=1.5, y=Inf, vjust=2, label="LOAEL", color="red")+
  ggtitle("Pentachlorophenol", subtitle="Cytoplasmic vacuolation in females")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(pcp.cy.f.orig)

#modeling
pm <- read.csv(file.path("BBMD input","pentachlorophenol-cyto-vacuolization-female-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "pentachlorophenol" & endpoint=="cyto" & sex=="female")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (15.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (13.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (19.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (10.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (16.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (8.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (11.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (3.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","pentachlorophenol-cyto-vacuolization-male-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 1.5, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

pcp.cy.f.dr <- ggarrange(pcp.cy.f.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(pcp.cy.f.dr)
ggsave("pentachlorophenol cytoplasmic vacuolization female.pdf",plot=pcp.cy.f.dr, width=24, height=6, path="dose-response plots")
```

#pentachlorophenol
Chronic inflammation male

```{r ggplot}
#pentachlorophenol
#Chronic inflammation male
pcp.inf.m.orig <- ggplot(subset(dr_dich, chemical %in% "pentachlorophenol" & endpoint=="inflammation" & sex=="male"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 1.5, linetype="dashed", color="red")+
  annotate("label", x=1.5, y=Inf, vjust=5, label="LOAEL", color="red")+
  ggtitle("Pentachlorophenol", subtitle="Chronic liver inflammation in males")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(pcp.inf.m.orig)

#modeling
pm <- read.csv(file.path("BBMD input","pentachlorophenol-chronic-inflammation-male-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "pentachlorophenol" & endpoint=="inflammation" & sex=="male")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (27.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (10.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (6.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (10.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (22.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (11.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (8.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (2.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","pentachlorophenol-chronic-inflammation-male-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 1.5, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

pcp.inf.m.dr <- ggarrange(pcp.inf.m.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(pcp.inf.m.dr)
ggsave("pentachlorophenol chronic inflammation male.pdf",plot=pcp.inf.m.dr, width=24, height=6, path="dose-response plots")
```

#pentachlorophenol
Chronic inflammation female

```{r ggplot}
#pentachlorophenol
#Chronic inflammation female
pcp.inf.f.orig <- ggplot(subset(dr_dich, chemical %in% "pentachlorophenol" & endpoint=="inflammation" & sex=="female"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 1.5, linetype="dashed", color="red")+
  annotate("label", x=1.5, y=Inf, vjust=2, label="LOAEL", color="red")+
  ggtitle("Pentachlorophenol", subtitle="Chronic liver inflammation in females")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(pcp.inf.f.orig)

#modeling
pm <- read.csv(file.path("BBMD input","pentachlorophenol-chronic-inflammation-female-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "pentachlorophenol" & endpoint=="inflammation" & sex=="female")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (14.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (17.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (17.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (14.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (12.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (7.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (12.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (3.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD input","pentachlorophenol-chronic-inflammation-female-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 1.5, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

pcp.inf.f.dr <- ggarrange(pcp.inf.f.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(pcp.inf.f.dr)
ggsave("pentachlorophenol chronic inflammation female.pdf",plot=pcp.inf.f.dr, width=24, height=6, path="dose-response plots")
```
